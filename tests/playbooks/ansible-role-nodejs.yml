---
- name: Test Node.js Role
  hosts: node1
  become: true
  vars:
    nodejs_verify_installation: true
  
  tasks:
    - name: Apply Node.js Role
      ansible.builtin.include_role:
        name: nodejs
  
  post_tasks:
    - name: "Test > Verify Node.js command is available"
      ansible.builtin.command: node --version
      register: test_node_version
      changed_when: false

    - name: "Test > Verify npm command is available"
      ansible.builtin.command: npm --version
      register: test_npm_version
      changed_when: false

    - name: "Test > Display Node.js version"
      ansible.builtin.debug:
        msg: "Node.js version: {{ test_node_version.stdout }}"

    - name: "Test > Display npm version"
      ansible.builtin.debug:
        msg: "npm version: {{ test_npm_version.stdout }}"

    - name: "Test > Verify metadata files exist"
      ansible.builtin.stat:
        path: "/var/lib/instance-metadata/{{ item }}"
      register: test_metadata_files
      loop:
        - nodejs-version
        - npm-version

    - name: "Test > Check metadata file contents"
      ansible.builtin.slurp:
        src: "/var/lib/instance-metadata/{{ item }}"
      register: test_metadata_contents
      loop:
        - nodejs-version
        - npm-version

    - name: "Test > Display metadata contents"
      ansible.builtin.debug:
        msg: "{{ item.item }}: {{ item.content | b64decode | trim }}"
      loop: "{{ test_metadata_contents.results }}"