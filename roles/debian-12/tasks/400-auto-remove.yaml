---
- name: Debian | Gather package dependencies (async)
  ansible.builtin.command: >
    apt-cache depends --recurse --no-recommends --no-suggests --no-conflicts
    --no-breaks --no-replaces --no-enhances "{{ item }}"
  loop: "{{ debian_packages | sort }}"
  register: debian_packages_dependencies
  async: 300
  poll: 0
  changed_when: false

- name: Debian | Wait for all dependency gathering jobs to complete
  ansible.builtin.async_status:
    jid: "{{ item.ansible_job_id }}"
  register: task_gather_dependencies
  until: task_gather_dependencies.finished
  retries: 30
  delay: 10
  loop: "{{ debian_packages_dependencies.results }}"

- name: Debian | Aggregate dependency results
  ansible.builtin.set_fact:
    debian_packages_dependencies: "{{ debian_packages_dependencies.results | map(attribute='stdout') | join('\n') | split('\n') | reject('match', '^(\\s+|<)') | unique | sort }}"

- name: Debian | Display dependencies
  ansible.builtin.debug:
    var: debian_packages_dependencies

- name: Debian | Get unique dependencies
  ansible.builtin.set_fact:
    debian_packages_dependencies: "{{ debian_packages_dependencies.results | map(attribute='stdout') | join('\n') | split('\n') | reject('match', '^(\\s+|<)') | unique | sort }}"

- name: Debian | Display unique dependencies
  ansible.builtin.debug:
    var: debian_packages_dependencies

- name: Debian | Gather APT packages
  ansible.builtin.package_facts:
    manager: auto

- name: Debian | Mark packages as manually installed
  when: item in ansible_facts.packages
  ansible.builtin.command: apt-mark manual "{{ item }}"
  loop: "{{ debian_packages_dependencies }}"
  changed_when: false

- name: Debian | Get packages to remove
  ansible.builtin.set_fact:
    debian_packages_remove: "{{ ansible_facts.packages.keys() | list | difference(debian_packages_dependencies) | sort }}"

- name: Debian | Display packages to remove
  ansible.builtin.debug:
    var: debian_packages_remove

# - name: Debian | Remove packages
#   ansible.builtin.apt:
#     name: "{{ debian_packages_remove }}"
#     state: absent
#     autoremove: true
#     purge: true
